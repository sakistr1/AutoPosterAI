<!DOCTYPE html>
<html lang="el">
<head>
  <meta charset="UTF-8" />
  <title>AutoPoster AI — Dashboard 2 (Production Engine)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --bg:#0b1220; --bg2:#0f172a; --card:#111827; --muted:#9ca3af; --text:#e5e7eb; --accent:#22c55e; --accent-2:#60a5fa; --danger:#ef4444; --border:#1f2937; }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial;color:var(--text);background:linear-gradient(180deg,var(--bg),var(--bg2))}
    header{display:flex;justify-content:space-between;align-items:center;padding:16px 20px;border-bottom:1px solid var(--border);background:#0b1220;position:sticky;top:0;z-index:10}
    header h1{font-size:18px;margin:0}
    .tags{display:flex;gap:8px;flex-wrap:wrap}
    .tag{display:inline-flex;align-items:center;gap:6px;background:#0b1020;border:1px solid var(--border);color:#cbd5e1;padding:4px 10px;border-radius:999px;font-size:12px;cursor:default}
    .tag.button{cursor:pointer}
    .wrap{max-width:1200px;margin:24px auto;padding:0 16px}
    .tabs{display:flex;gap:6px;border-bottom:1px solid var(--border)}
    .tab{padding:10px 14px;border:1px solid var(--border);border-bottom:none;border-radius:12px 12px 0 0;background:#0b1020;color:#cbd5e1;cursor:pointer}
    .tab.active{background:var(--card);color:#fff}
    .tab-content{border:1px solid var(--border);border-top:none;background:var(--card);border-radius:0 14px 14px 14px;padding:16px}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    .row-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:16px}
    .card{background:#0b1020;border:1px solid var(--border);border-radius:14px;padding:14px}
    h2{font-size:16px;margin:0 0 10px}
    label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px}
    input,select,button,textarea{width:100%;background:#070d1a;border:1px solid var(--border);color:#var(--text);padding:10px 12px;border-radius:10px}
    input:focus,select:focus,textarea:focus{outline:none;border-color:#334155}
    .btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;border-radius:10px;border:1px solid var(--border);padding:10px 14px;cursor:pointer;background:#0c1327}
    .btn-primary{background:var(--accent);border-color:transparent;color:#0b1220;font-weight:600}
    .btn-alt{background:#0c1633}
    .btn-danger{background:#1b0b0b;border-color:#3b0c0c;color:#fca5a5}
    .grid{display:grid;grid-template-columns:repeat(4,1fr);gap:12px}
    .template-card,.product-card{border:1px solid var(--border);border-radius:12px;padding:10px;background:#0b1020;cursor:pointer}
    .template-card.active,.product-card.active{border-color:var(--accent);box-shadow:0 0 0 2px rgba(34,197,94,.2) inset}
    .muted{color:var(--muted);font-size:13px}
    .small{font-size:12px;color:#94a3b8}
    .hint{display:block;margin-top:4px;font-size:12px;color:#9ca3af}
    .preview{display:grid;grid-template-columns:repeat(4,1fr);gap:12px}
    .preview img,.preview video{width:100%;border-radius:12px;border:1px solid var(--border);background:#0b1020}
    .actions{display:flex;gap:8px;flex-wrap:wrap}
    .status{margin-top:8px;font-size:12px}
    .ok{color:#86efac}.warn{color:#facc15}.err{color:#fca5a5}
    .spacer{height:8px}
    .product-actions .btn{width:100%}
    .product-card .muted.small{display:block;margin-top:4px}
    @media (max-width: 980px){ .row,.row-3,.preview,.grid{grid-template-columns:1fr} }
  </style>
</head>
<body>
  <header>
    <h1>AutoPoster AI — Production Dashboard</h1>
    <div class="tags">
      <span class="tag">Preview = Free</span>
      <span class="tag">Commit = −1 credit</span>
      <span class="tag">Απομονωμένο subsystem</span>
      <span class="tag button" id="btnSetToken">Set Token</span>
      <span class="tag" id="tokenState">No token</span>
      <span class="tag" id="creditsBadge">Credits: —</span>
    </div>
  </header>

  <div class="wrap">
    <div class="tabs">
      <div class="tab active" data-tab="templates">Templates</div>
      <div class="tab" data-tab="products">Προϊόντα</div>
      <div class="tab" data-tab="previews">Previews</div>
    </div>

    <div class="tab-content" id="tab-templates">
      <div class="row">
        <div class="card">
          <h2>Λίστα Templates</h2>
          <div class="muted small">MVP: manual λίστα για αρχή. Μετά DB + mapping.</div>
          <div class="spacer"></div>
          <div class="grid" id="templatesGrid"></div>
        </div>

        <div class="card">
          <h2>Επιλογές Render</h2>
          <div class="row-3">
            <div>
              <label for="postType">Τύπος Post</label>
              <select id="postType">
                <option value="image">Image</option>
                <option value="carousel">Carousel</option>
                <option value="video">Video</option>
              </select>
            </div>
            <div>
              <label for="mode">Ύφος</label>
              <select id="mode">
                <option>Κανονικό</option>
                <option>Χιουμοριστικό</option>
                <option>Επαγγελματικό</option>
                <option>Ρομαντικό</option>
                <option>Επιθετικό Marketing</option>
              </select>
            </div>
            <div>
              <label for="productId">Product ID (προσωρινά)</label>
              <input id="productId" placeholder="π.χ. 101" />
            </div>
          </div>

          <div class="spacer"></div>
          <div class="row-3">
            <div>
              <label for="brandLogo">Λογότυπο <span class="small">*</span></label>
              <input type="file" id="brandLogo" accept=".png,.jpg,.jpeg,.svg" />
              <span class="hint">* Προαιρετικό. SVG/PNG με διαφάνεια.</span>
              <div id="brandLogoPreview" class="small muted" style="margin-top:6px;"></div>
            </div>
            <div>
              <label for="extraImages">Extra φωτογραφίες <span class="small">*</span></label>
              <input type="file" id="extraImages" accept=".png,.jpg,.jpeg,.webp" multiple />
              <span class="hint">* 2–4 εικόνες, ≥1200px.</span>
              <div id="extraImagesPreview" class="small muted" style="margin-top:6px;"></div>
            </div>
            <div>
              <label>&nbsp;</label>
              <div class="small muted">Προαιρετικά για καλύτερο αποτέλεσμα.</div>
            </div>
          </div>

          <div class="spacer"></div>
          <div class="actions">
            <button class="btn btn-primary" id="btnRender">Δημιουργία Preview</button>
            <button class="btn btn-alt" id="btnReset">Reset</button>
          </div>
          <div class="status muted" id="status"></div>
        </div>
      </div>

      <div class="spacer"></div>
      <div class="card">
        <h2>Αποτελέσματα</h2>
        <div id="previewGrid" class="preview">
          <div class="muted">Κανένα preview ακόμα.</div>
        </div>
      </div>
    </div>

    <div class="tab-content" id="tab-products" style="display:none">
      <div class="card">
        <h2>Προϊόντα (MVP)</h2>
        <div class="muted small">Επιλέγεις κάρτα ή πατάς «Δημιουργία Εικόνας» για preview.</div>
        <div class="spacer"></div>
        <div class="grid" id="productsGrid">
          <div class="product-card" data-id="101">
            <strong>#101</strong><br>
            <span class="muted small">Demo Product</span>
            <div class="spacer"></div>
            <div class="actions product-actions">
              <button class="btn btn-primary btn-create-image" data-id="101">Δημιουργία Εικόνας</button>
            </div>
          </div>
          <div class="product-card" data-id="102">
            <strong>#102</strong><br>
            <span class="muted small">Demo Product</span>
            <div class="spacer"></div>
            <div class="actions product-actions">
              <button class="btn btn-primary btn-create-image" data-id="102">Δημιουργία Εικόνας</button>
            </div>
          </div>
          <div class="product-card" data-id="103">
            <strong>#103</strong><br>
            <span class="muted small">Demo Product</span>
            <div class="spacer"></div>
            <div class="actions product-actions">
              <button class="btn btn-primary btn-create-image" data-id="103">Δημιουργία Εικόνας</button>
            </div>
          </div>
          <div class="product-card" data-id="104">
            <strong>#104</strong><br>
            <span class="muted small">Demo Product</span>
            <div class="spacer"></div>
            <div class="actions product-actions">
              <button class="btn btn-primary btn-create-image" data-id="104">Δημιουργία Εικόνας</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="tab-content" id="tab-previews" style="display:none">
      <div class="card">
        <h2>Ιστορικό (DB)</h2>
        <div class="muted small">Committed posts από τη βάση.</div>
        <div class="spacer"></div>
        <div id="history" class="preview">
          <div class="muted">Κενό.</div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ---- State ----
    const state = {
      selectedTemplateId: null,
      selectedProductId: null,
      previews: [],
      brandLogoUrl: null,
      extraImageUrls: [],
    };

    // ---- Helpers ----
    const el = (id) => document.getElementById(id);
    const $ = (sel, root=document) => root.querySelector(sel);
    const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));
    const setStatus = (msg, cls='muted') => { const s = el('status'); s.className = 'status ' + cls; s.textContent = msg; };

    const getToken = () => localStorage.getItem('token') || '';
    function updateTokenState(){
      const t = getToken();
      const s = el('tokenState');
      if (s) s.textContent = t ? 'Token: set' : 'No token';
    }
    async function refreshCredits(){
      const badge = el('creditsBadge');
      const t = getToken();
      if (!badge) return;
      if (!t){ badge.textContent = 'Credits: —'; return; }
      try{
        const res = await fetch('/me/credits', { headers: { Authorization: 'Bearer ' + t } });
        if (!res.ok) throw new Error('HTTP ' + res.status);
        const data = await res.json();
        const n = (data && typeof data.credits === 'number') ? data.credits : '?';
        badge.textContent = 'Credits: ' + n;
      }catch(_){
        badge.textContent = 'Credits: ?';
      }
    }

    // ---- Tabs ----
    $$('.tab').forEach(t => t.addEventListener('click', () => {
      $$('.tab').forEach(x => x.classList.remove('active'));
      t.classList.add('active');
      const name = t.dataset.tab;
      $$('.tab-content').forEach(c => c.style.display = 'none');
      el('tab-' + name).style.display = '';
      if (name === 'previews') refreshCommitted();
    }));

    // ---- Templates (MVP: manual list) ----
    const templates = [
      { id: 1, name: 'img_product_clean', type: 'image', ratio: '1:1' },
      { id: 2, name: 'img_lifestyle_hint', type: 'image', ratio: '4:5' },
      { id: 3, name: 'img_discount_card', type: 'image', ratio: '1:1' },
      { id: 4, name: 'car_features_steps', type: 'carousel', ratio: '1:1' },
      { id: 5, name: 'car_multi_grid', type: 'carousel', ratio: '4:5' },
      { id: 6, name: 'vid_slideshow_overlay', type: 'video', ratio: '9:16' },
    ];

    const templatesGrid = el('templatesGrid');
    function renderTemplates() {
      templatesGrid.innerHTML = '';
      templates.forEach(t => {
        const div = document.createElement('div');
        div.className = 'template-card';
        div.dataset.id = t.id;
        div.innerHTML = `<strong>#${t.id} ${t.name}</strong><br><span class="muted small">${t.type.toUpperCase()} • ${t.ratio}</span>`;
        div.addEventListener('click', () => {
          $$('.template-card').forEach(x => x.classList.remove('active'));
          div.classList.add('active');
          state.selectedTemplateId = t.id;
          setStatus(`Επιλέχθηκε template #${t.id}`, 'ok');
          el('postType').value = (t.type === 'carousel') ? 'carousel' : (t.type === 'video' ? 'video' : 'image');
        });
        templatesGrid.appendChild(div);
      });
    }
    renderTemplates();

    // ---- Products selection (γεμίζει και το input) ----
    $$('#productsGrid .product-card').forEach(card => {
      card.addEventListener('click', () => {
        $$('#productsGrid .product-card').forEach(x => x.classList.remove('active'));
        card.classList.add('active');
        const id = parseInt(card.dataset.id, 10);
        state.selectedProductId = id;
        el('productId').value = id;
        setStatus(`Επιλέχθηκε προϊόν #${id}`, 'ok');
      });
    });

    // ---- Upload handlers ----
    async function uploadSingle(endpoint, file) {
      const form = new FormData();
      form.append('file', file);
      const res = await fetch(endpoint, { method: 'POST', body: form });
      if (!res.ok) throw new Error('HTTP ' + res.status);
      const json = await res.json();
      return json.url; // string
    }

    async function uploadMultiple(endpoint, files, productId) {
      const form = new FormData();
      [...files].forEach(f => form.append('files', f));
      form.append('product_id', productId);
      const res = await fetch(endpoint, { method: 'POST', body: form });
      if (!res.ok) throw new Error('HTTP ' + res.status);
      const json = await res.json();
      return json.urls || []; // string[]
    }

    const brandLogoInput = el('brandLogo');
    const brandLogoPreview = el('brandLogoPreview');
    brandLogoInput.addEventListener('change', async (e) => {
      const file = e.target.files?.[0];
      if (!file) return;
      brandLogoPreview.textContent = 'Ανέβασμα...';
      try {
        const url = await uploadSingle('/assets/upload_logo', file);
        state.brandLogoUrl = url;
        brandLogoPreview.innerHTML = `OK <span class="ok">(${url})</span>`;
      } catch (err) {
        brandLogoPreview.innerHTML = `<span class="err">Αποτυχία: ${err.message}</span>`;
      }
    });

    const extraImagesInput = el('extraImages');
    const extraImagesPreview = el('extraImagesPreview');
    extraImagesInput.addEventListener('change', async (e) => {
      const files = e.target.files || [];
      if (!files.length) return;
      const pid = el('productId').value;
      if (!pid) {
        extraImagesPreview.innerHTML = '<span class="warn">Δώσε πρώτα Product ID.</span>';
        return;
      }
      extraImagesPreview.textContent = 'Ανέβασμα...';
      try {
        const urls = await uploadMultiple('/assets/upload_product_images', files, pid);
        state.extraImageUrls = urls;
        extraImagesPreview.innerHTML = `OK: ${urls.length} εικόνες`;
      } catch (err) {
        extraImagesPreview.innerHTML = `<span class="err">Αποτυχία: ${err.message}</span>`;
      }
    });

    // ---- Preview render ----
    function isPlaceholderUrl(u){
      const s = String(u || '');
      return s.includes('<') || s.includes('>') || s.includes('%3C') || s.includes('%3E') || s.includes('from_render');
    }

    async function doRender() {
      const template_id = state.selectedTemplateId || 1;
      const product_id = el('productId').value ? parseInt(el('productId').value, 10) : null;
      const post_type = el('postType').value || 'image';
      const mode = el('mode').value || 'Κανονικό';

      if (!template_id) { setStatus('Διάλεξε template.', 'warn'); return; }
      if (!post_type) { setStatus('Διάλεξε τύπο post.', 'warn'); return; }

      setStatus('Δημιουργία preview...', 'muted');
      try {
        const res = await fetch('/previews/render', {
          method: 'POST',
          headers: { 'Content-Type':'application/json' },
          body: JSON.stringify({
            template_id, product_id, post_type, mode,
            brand_logo_url: state.brandLogoUrl || null,
            extra_images: state.extraImageUrls || []
          })
        });
        if (!res.ok) throw new Error('HTTP ' + res.status);
        const data = await res.json();
        appendPreviewResult(data);
        setStatus('OK', 'ok');
        refreshCredits(); // keep badge fresh
      } catch (err) {
        console.error(err);
        setStatus('Απέτυχε το preview: ' + err.message, 'err');
      }
    }

    // ---- Commit (−1 credit) ----
    async function commitPreview(preview, btn){
      const t = getToken();
      if (!t){ alert('Βάλε token (Set Token) πριν το commit.'); return; }
      btn.disabled = true;
      btn.textContent = 'Committing…';
      try{
        const res = await fetch('/previews/commit', {
          method: 'POST',
          headers: {
            'Content-Type':'application/json',
            'Authorization': 'Bearer ' + t
          },
          body: JSON.stringify({ preview_id: preview.preview_id, urls: preview.urls || [] })
        });
        if (!res.ok){
          if (res.status === 402){
            alert('Αποτυχία commit: Δεν έχεις credits.');
            btn.disabled = false;
            btn.textContent = 'Commit (−1 credit)';
            await refreshCredits();
            return;
          }
          const text = await res.text();
          throw new Error(text || ('HTTP ' + res.status));
        }
        btn.textContent = 'Committed';
        btn.disabled = true;
        await refreshCommitted();
        await refreshCredits();
      }catch(err){
        alert('Απέτυχε: ' + err.message);
        btn.disabled = false;
        btn.textContent = 'Commit (−1 credit)';
      }
    }

    function appendPreviewResult(data) {
      const grid = el('previewGrid');
      if (state.previews.length === 0) grid.innerHTML = '';

      // sanitize urls
      let urls = Array.isArray(data.urls) ? data.urls.filter(u => !isPlaceholderUrl(u)) : [];
      const hadInvalid = (Array.isArray(data.urls) && urls.length !== data.urls.length);

      const card = document.createElement('div');
      card.className = 'card';

      const mediaWrap = document.createElement('div');
      mediaWrap.className = 'preview';

      if (urls.length === 0){
        const warn = document.createElement('div');
        warn.className = 'small err';
        warn.textContent = 'Το render δεν επέστρεψε έγκυρο αρχείο. Έλεγξε το backend (previews/render).';
        card.appendChild(warn);
      } else {
        urls.forEach(u => {
          if (u.endsWith('.mp4')) {
            const v = document.createElement('video');
            v.src = u; v.controls = true; v.playsInline = true;
            mediaWrap.appendChild(v);
          } else {
            const img = document.createElement('img');
            img.src = u; img.loading = 'lazy';
            mediaWrap.appendChild(img);
          }
        });
        card.appendChild(mediaWrap);
      }

      if (hadInvalid){
        const info = document.createElement('div');
        info.className = 'small warn';
        info.textContent = 'Παράχθηκαν μη έγκυρα URLs (placeholder). Αγνοήθηκαν.';
        card.appendChild(info);
      }

      const meta = document.createElement('div');
      meta.className = 'small muted';
      meta.textContent = `preview_id: ${data.preview_id}`;

      const btn = document.createElement('button');
      btn.className = 'btn btn-primary';
      btn.textContent = 'Commit (−1 credit)';
      btn.addEventListener('click', () => commitPreview(data, btn));

      card.appendChild(document.createElement('div')).className = 'spacer';
      card.appendChild(btn);
      card.appendChild(document.createElement('div')).className = 'spacer';
      card.appendChild(meta);

      grid.prepend(card);

      // Τοπικό mini-history (session)
      const hist = el('history');
      if (state.previews.length === 0) hist.innerHTML = '';
      const item = document.createElement('div');
      item.className = 'card';
      item.innerHTML = `
        <div class="small muted">preview_id: ${data.preview_id}</div>
        <div class="small">${urls.length} αρχεία</div>
      `;
      hist.prepend(item);

      state.previews.push({ ...data, urls });
    }

    // ---- ΙΣΤΟΡΙΚΟ (DB) ----
    async function refreshCommitted(){
      const cont = el('history');
      if (!cont) return;
      cont.innerHTML = '<div class="muted">Φόρτωση…</div>';
      try{
        const res = await fetch('/previews/committed?limit=20&offset=0');
        if (!res.ok) throw new Error('HTTP ' + res.status);
        let payload = await res.json();

        const rows = Array.isArray(payload) ? payload
                   : (payload && Array.isArray(payload.items)) ? payload.items
                   : [];

        if (!rows.length){
          cont.innerHTML = '<div class="muted">Κενό.</div>';
          return;
        }

        cont.innerHTML = '';
        rows.forEach(item => {
          let urls = item.urls ?? item.urls_json ?? [];
          if (typeof urls === 'string') {
            try { urls = JSON.parse(urls); } catch { urls = []; }
          }
          if (!Array.isArray(urls)) urls = [];
          urls = urls.filter(u => !isPlaceholderUrl(u));

          const box = document.createElement('div');
          box.className = 'card';

          const media = urls.map(u => {
            const safe = String(u || '');
            if (safe.endsWith('.mp4')) {
              return `<video src="${safe}" controls playsinline style="width:100%;border:1px solid var(--border);border-radius:8px;margin-top:6px"></video>`;
            }
            return `<img src="${safe}" style="width:100%;border:1px solid var(--border);border-radius:8px;margin-top:6px">`;
          }).join('');

          box.innerHTML = `
            <div class="small muted">post_id: ${item.id ?? ''}</div>
            <div class="small muted">preview_id: ${item.preview_id ?? ''}</div>
            <div class="small muted">${item.created_at ?? ''}</div>
            ${media || '<div class="small muted">— χωρίς media —</div>'}
          `;
          cont.appendChild(box);
        });
      }catch(err){
        cont.innerHTML = `<div class="err small">Αποτυχία ιστορικού: ${err.message}</div>`;
      }
    }

    function doReset() {
      state.selectedTemplateId = null;
      state.selectedProductId = null;
      state.previews = [];
      state.brandLogoUrl = null;
      state.extraImageUrls = [];
      $$('.template-card').forEach(x => x.classList.remove('active'));
      $$('#productsGrid .product-card').forEach(x => x.classList.remove('active'));
      el('productId').value = '';
      el('brandLogo').value = '';
      el('extraImages').value = '';
      el('brandLogoPreview').textContent = '';
      el('extraImagesPreview').textContent = '';
      el('previewGrid').innerHTML = '<div class="muted">Κανένα preview ακόμα.</div>';
      el('history').innerHTML = '<div class="muted">Κενό.</div>';
      setStatus('Reset.', 'muted');
      refreshCredits();
    }

    // ---- Δημιουργία Preview από κάρτα προϊόντος (Engine flow) ----
    async function createImagePreview(productId, btn){
      const originalText = btn.textContent;
      btn.disabled = true;
      btn.textContent = 'Δημιουργία preview…';
      try{
        el('productId').value = productId;           // συγχρονίζουμε input
        el('postType').value = 'image';              // εξαναγκάζουμε image
        await doRender();                            // free render
      } finally {
        btn.disabled = false;
        btn.textContent = originalText;
      }
    }

    // ---- Buttons / init ----
    el('btnRender').addEventListener('click', doRender);
    el('btnReset').addEventListener('click', doReset);

    el('btnSetToken').addEventListener('click', () => {
      const val = prompt('Δώσε JWT token (ΜΟΝΟ το token, χωρίς "Bearer ")');
      if (!val) return;
      localStorage.setItem('token', val.trim());
      updateTokenState();
      refreshCredits();
    });

    // Listeners για «Δημιουργία Εικόνας» στις κάρτες
    $$('.btn-create-image').forEach(btn => {
      btn.addEventListener('click', (e) => {
        e.stopPropagation();
        const pid = btn.dataset.id;
        if (!pid){ alert('Άγνωστο Product ID'); return; }
        createImagePreview(pid, btn);
      });
    });

    // αρχικοποίηση
    updateTokenState();
    refreshCredits();
    refreshCommitted();
  </script>
</body>
</html>
